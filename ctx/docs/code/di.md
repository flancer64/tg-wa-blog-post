# Dependency Injection Contract

Path: `./ctx/docs/code/di.md`

## Назначение

Документ фиксирует правила использования `@teqfw/di` в Telegram Translation Publisher. Уровень определяет допустимую модель связывания зависимостей, namespace-структуру и ограничения на использование контейнера.

## Общая модель

`@teqfw/di` является единственным допустимым механизмом связывания project-кода.

Статические `import` project-модулей внутри `src/` запрещены.  
Статические импорты допускаются только:

- в composition root (bootstrap);
- в тестах.

Все связи между компонентами приложения осуществляются через DI-контейнер.

## Внедрение зависимостей

Зависимости внедряются контейнером через конструктор класса.

- Имена параметров конструктора должны соответствовать Dependency ID.
- Контейнер резолвит зависимости на основе namespace-правил и ID-модели (`$`, `$$`, `node:`).
- Классы не взаимодействуют с контейнером напрямую.

Запрещено:

- вызывать `container.get()` внутри классов;
- передавать контейнер в бизнес-логику;
- создавать зависимости вручную через `new` (если это не локальные value-объекты);
- использовать container как service locator.

## Namespace-модель

В проекте используется только один namespace root:

```txt
Ttp_Back_
```

Другие namespace (Shared, Web и т.п.) не допускаются в рамках текущего продукта.

Namespace фиксируется на уровне bootstrap и не расширяется динамически в исполняемом коде.

## Platform API

Доступ к Node.js API осуществляется исключительно через DI с использованием `node:` Dependency ID:

```txt
node:fs
node:path
node:process
```

Статические импорты platform API внутри прикладного или инфраструктурного кода запрещены.

## node_modules зависимости

Все зависимости из `node_modules` подключаются исключительно через DI с использованием `node:<pkg>` Dependency ID.

Прямой статический `import` библиотек (включая HTTP-клиенты и LLM SDK) запрещён.

## Composition Root

В исполняемом коде существует ровно один composition root — bootstrap.

В тестах допускается отдельный composition root.

`container.register`:

- запрещён в исполняемом коде;
- разрешён только в тестах.

Использование `container.get()` вне composition root и тестов запрещено.

## Factory-объекты

Factory-объекты в проекте не используются и не допускаются. Создание объектов осуществляется контейнером напрямую через ID-модель.

## Dependency ID модель

Обязательное использование:

- `$` — для singleton;
- `$$` — для нового экземпляра;
- `node:` — для platform и node_modules зависимостей.

Использование `.export` запрещено.

## Разрешённые Dependency ID

Dependency ID в конструкторах и `container.get(...)` должны ссылаться только на реально существующие источники кода.

Разрешены только:

- project-компоненты, для которых существует исходный файл в `src/` и которые резолвятся через namespace root;
- platform/node_modules зависимости в формате `node:*`.

Запрещено:

- вводить произвольные или временные Dependency ID без соответствующего исходного компонента;
- вводить value-ID, которые не соответствуют модулю проекта или `node:*`, в production graph;
- формировать скрытые runtime-зависимости через выдуманные DI-ID.

Если runtime-данные (например, `projectRoot`) нужны компоненту, они передаются явно аргументами публичных методов runtime-цикла, а не через выдуманные DI-зависимости.

## Test Mode

В тестах обязательно используется `enableTestMode()`.

Тесты имеют право:

- переопределять зависимости через `container.register`;
- подменять `node:` зависимости;
- изолировать внешние адаптеры.

Исполняемый код не должен зависеть от test mode.

## Итог

DI-модель Telegram Translation Publisher является строгой, централизованной и минималистичной. Все зависимости внедряются через конструктор. Контейнер не используется как service locator. Статическое связывание project-кода запрещено, что обеспечивает тестируемость, детерминированность и архитектурную целостность системы.
