# Storage Overview

Path: `./ctx/docs/code/storage/overview.md`

## Назначение

Документ фиксирует правила работы файлового хранилища Telegram Translation Publisher. Уровень определяет модель записи агрегатов, правила проверки существования и ограничения на изменение данных.

## Общая модель

Storage предназначен для:

- записи агрегатов в файловую систему;
- проверки существования агрегата по `ru_message_id`.

Storage не используется для чтения агрегатов в прикладной логике. Чтение допускается только для проверки существования.

## Каталог хранения

Хранилище расположено в каталоге:

```txt
./var/data/
```

Путь трактуется относительно `projectRoot`, вычисленного в bootstrap и переданного в прикладной слой.

Каталог может создаваться storage-слоем при необходимости.

## Имя файла

Формат имени файла:

```txt
<timestamp>_<ru_message_id>.json
```

- `timestamp` соответствует моменту формирования агрегата;
- используется локальное время;
- расширение файла строго `.json`.

Проверка существования агрегата выполняется по шаблону, включающему `ru_message_id`.

## Формат данных

Агрегат сохраняется:

- в формате JSON;
- в кодировке UTF-8 без BOM.

## Атомарность записи

Запись агрегата выполняется атомарно:

1. запись во временный файл;
2. переименование (rename) во финальное имя.

Прямая запись в итоговое имя запрещена.

## Запрет модификации

Запрещено:

- перезаписывать существующий агрегат;
- редактировать агрегат;
- удалять агрегат.

Storage реализует append-only модель хранения.

## Ошибки записи

При ошибке записи storage:

- выбрасывает исключение;
- не выполняет частичной записи.

## Повторная обработка

Если агрегат для данного `ru_message_id` уже существует, повторная обработка не выполняется.

## Расширяемость

Storage навсегда остаётся файловым. Переход на базу данных или облачное хранилище не предполагается в рамках данного продукта.

## Итог

Storage Telegram Translation Publisher реализует простую файловую append-only модель с атомарной записью агрегатов, проверкой существования по шаблону имени файла и запретом на модификацию ранее сохранённых данных.
