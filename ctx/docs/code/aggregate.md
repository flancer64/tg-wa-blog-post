# Aggregate Contract

Path: `./ctx/docs/code/aggregate.md`

## Назначение

Документ фиксирует кодовую модель агрегата Telegram Translation Publisher. Уровень определяет правила формирования агрегата, его структуру, иммутабельность и связь с процессом выполнения.

## Общая модель

Агрегат является финальной фиксацией результата одного репликационного цикла.

Агрегат:

- формируется отдельным компонентом (например, `AggregateFactory`);
- не формируется внутри `App`;
- создаётся единожды в конце прикладного цикла;
- представляет собой чистый объект без знания о механизме хранения.

## Момент формирования

Агрегат создаётся после завершения всех прикладных фаз:

- чтение ru-сообщения;
- перевод;
- публикация в en;
- публикация в es.

Агрегат не формируется до получения `ru_message_id`.

Агрегат формируется только при наличии `ru_message_id`, даже если статус выполнения — failure.

Если запись агрегата в хранилище не удалась, агрегат считается не созданным.

## Иммутабельность

Агрегат является финальным immutable-объектом.

После создания:

- агрегат не изменяется;
- система не выполняет его повторную валидацию;
- система не читает агрегаты в процессе выполнения.
- агрегат не выполняется системой после записи.

Агрегаты предназначены для людей и внешнего анализа, а не для внутренней логики системы.

## Обязательные поля

Агрегат обязан содержать:

- `timestamp` — время формирования в формате ISO 8601;
- `ru_message_id`;
- `ru_text`;
- `en_text`;
- `es_text`;
- `en_publish_result`;
- `es_publish_result`;
- `status` — `success` или `failure`.

Допускается наличие дополнительных полей при необходимости.

## Частичный failure

Если один перевод или одна публикация завершились неуспешно:

- агрегат всё равно формируется;
- в агрегате фиксируются все полученные данные;
- поля переводов записываются, если они были получены;
- `status` определяется строго по результатам публикации.

## Определение статуса

Поле `status` определяется исключительно на основе результатов публикации.

Ошибки записи агрегата в файловую систему не влияют на вычисление `status`, но приводят к отсутствию сохранённого агрегата.

## Связь со storage

Агрегат формируется как чистый объект и не содержит метаданных storage (имя файла, путь, расположение).

Определение имени файла и запись на диск являются ответственностью storage-слоя.

## Детерминизм

Агрегат отражает фактическое состояние публикации на момент завершения прикладного цикла, а не намерение системы.

Runtime не создаёт второй агрегат при наличии существующего.

## Итог

Агрегат Telegram Translation Publisher является неизменяемой фиксацией факта выполнения одного цикла. Он создаётся отдельным компонентом, формируется после завершения прикладных фаз и записывается в хранилище без последующей обработки системой.
