# Code Conventions

Path: `./ctx/docs/code/conventions.md`

## Назначение

Документ фиксирует инженерные конвенции кода проекта.
Он определяет допустимые языки, модель организации кода, правила DI, формат взаимодействия с платформой и общие инварианты реализации.

Документ не содержит архитектурных, продуктовых или доменных утверждений.

---

## Язык и диалект

- Основной язык кода — JavaScript (ESM).
- Используются `.mjs`-модули.
- TypeScript запрещён.
- CommonJS допускается только внутри сторонних зависимостей.
- Исполняемым кодом проекта считается только JavaScript.

---

## Структура исходного кода

- Исходный код размещается в `src/`.
- Тесты размещаются в `test/`.
- Namespace root задаётся в bootstrap и не расширяется динамически.
- В production-коде используется один namespace root.

---

## Dependency Injection

- Используется только `@teqfw/di`.
- Все зависимости внедряются через конструктор.
- Классы не взаимодействуют с контейнером напрямую.
- Контейнер не передаётся в бизнес-логику.

Запрещено:

- использовать container как service locator;
- вызывать `container.get()` вне composition root и тестов;
- создавать проектные зависимости через `new`, если они являются частью DI-графа.

### Dependency ID модель

Используются:

- `$` — singleton;
- `$$` — новый экземпляр;
- `node:` — platform и node_modules зависимости.

`.export` не используется.

---

## Composition Root

- В системе существует ровно один production composition root.
- `container.register` запрещён в production-коде.
- В тестах допускается.

Composition root отвечает только за:

- создание контейнера;
- настройку namespace;
- получение entrypoint-компонента;
- завершение процесса с возвращённым кодом.

---

## Работа с Platform API

Platform API подключается через DI с использованием `node:` Dependency ID.

Статические импорты platform API внутри прикладного кода запрещены.

---

## Конфигурация

- Работа с `process.env` изолируется в отдельном компоненте.
- Использование сторонних библиотек для загрузки `.env` запрещено.
- Конфигурация передаётся как immutable-объект.
- Значения конфигурации не мутируются в runtime.

---

## Асинхронность

- Используется `async/await`.
- Promise-модель является базовой.
- Смешивание callback- и promise-моделей допускается только при интеграции с внешними API.
- Блокирующие операции запрещены.

---

## Состояние и мутабельность

- Глобальное пользовательское состояние запрещено.
- Допускается только platform-state (`process`).
- Объекты, представляющие результат вычисления, рекомендуется делать immutable.
- Изменение состояния должно быть локализовано и явным.

---

## Обработка ошибок

- Исключения допускаются в нижних слоях.
- Централизация обработки ошибок осуществляется в верхнем слое исполнения.
- Публичные entrypoint-методы не должны выбрасывать необработанные исключения.
- Преобразование ошибок в exit-code выполняется централизованно.

---

## Логирование

- Используется централизованный Logger через DI.
- `console.*` запрещён.
- Логирование не должно изменять поведение программы.
- Секреты не должны попадать в лог.

---

## Storage

- Модель хранения определяется архитектурным уровнем.
- Кодовый слой обязан обеспечивать:
  - атомарность записи;
  - запрет частичной фиксации;
  - отсутствие скрытой мутации сохранённых данных.

Конкретные пути, форматы и доменные идентификаторы в данном документе не фиксируются.

---

## Тестирование

Поддерживаются:

- unit-тесты;
- dev-тесты.

### Unit

- Строгая DI-изоляция.
- Запрещены реальные side effects.
- Каждый тест создаёт собственный контейнер.
- Обязательно `enableTestMode()`.

### Dev

- Допускаются реальные интеграционные вызовы.
- Не создают альтернативного production-режима.
- Каждый тест создаёт собственный контейнер.

Сторонние тестовые фреймворки не используются. Применяется `node:test`.

---

## Запрещённое

- TypeScript
- eval
- Динамические namespace
- Альтернативные DI-механизмы
- Второй production composition root
- Прямое использование container внутри бизнес-классов

---

## Инженерная дисциплина

- Все комментарии в коде — только на английском.
- Лог-сообщения — только на английском.
- Новые классы отражаются в `types.d.ts`.
- Нарушение конвенций считается техническим долгом.

---
