# Testing Contract

Path: `./ctx/docs/code/testing.md`

## Назначение

Документ фиксирует инженерные инварианты unit-тестирования Telegram Translation Publisher. Уровень определяет структуру размещения тестов, тестовой composition root, DI-модель и требования к изоляции.

Тесты рассматриваются как равноправная часть кодовой базы.

## Статус тестов в проекте

Для всех `.mjs`-модулей в `src/` наличие unit-тестов является нормой по умолчанию.

Отсутствие теста допускается только для:

- production bootstrap (см. `./ctx/docs/code/bootstrap.md`);
- CLI entry-файла.

## Структура каталогов

### Корневой каталог

Unit-тесты размещаются исключительно в:

```txt
./test/unit/
```

Размещение тестов внутри `src/` не допускается.

### Зоны тестирования

Если проект содержит несколько зон исполнения, тесты разделяются по зонам:

```txt
test/unit/back/
test/unit/web/
```

В текущем продукте используется backend-зона:

```txt
test/unit/back/
```

### Зеркальность структуры

Структура каталогов внутри `test/unit/back/` повторяет структуру `src/`.

Пример соответствия:

```txt
src/Service/Publisher.mjs
→
test/unit/back/Service/Publisher.test.mjs
```

Зеркальность структуры является обязательной.

## Тестовой composition root

Unit-тесты используют отдельный bootstrap, независимый от production bootstrap.

Тестовой composition root размещается в:

```txt
test/unit/unit-bootstrap.mjs
```

Нормативная форма и инварианты данного модуля зафиксированы в `./ctx/docs/code/testing/unit-bootstrap.md`.

Тестовой bootstrap:

- является единственной точкой инициализации DI-контейнера в тестовой зоне;
- не использует production bootstrap;
- не расширяет namespace-модель;
- создаёт изолированный контейнер для каждого теста.

Модель тестового bootstrap симметрична production bootstrap, но ограничена задачами unit-изоляции.

## DI-модель тестов

В unit-тестах:

- создаётся собственный DI-контейнер для каждого теста;
- обязательно использование `enableTestMode()`;
- production-код не импортируется статически;
- доступ к production-компонентам осуществляется исключительно через `container.get(...)`;
- допускается `container.register` для подмены зависимостей.

Использование DI-контейнера вне test bootstrap не допускается.

Тест, обходящий DI-контейнер, считается нарушением инженерного контракта.

## Изоляция и side effects

Unit-тесты не выполняют реальные побочные действия.

Запрещён прямой доступ к:

- файловой системе;
- `./var/data`;
- Telegram API;
- LLM API;
- сети;
- процессам;
- таймерам.

Все внешние зависимости внедряются через DI и могут быть подменены.

Каждый тест является изолированным и идемпотентным.

## Инструменты тестирования

Нормативный стек:

- `node:test`;
- `node:assert/strict`.

Использование сторонних библиотек тестирования не допускается.

## Параллельность

Параллельный запуск тестов допускается.

Тесты не зависят друг от друга и не используют shared state.

## Типы тестов

В рамках текущего продукта поддерживаются только unit-тесты.

Интеграционные и e2e-тесты не входят в контракт.

## Итог

Testing-контракт Telegram Translation Publisher фиксирует:

- обязательность unit-тестов для production-кода;
- размещение тестов в `./test/unit/` с зеркальной структурой;
- использование отдельного тестового bootstrap;
- строгую DI-изоляцию;
- запрет side effects;
- использование стандартных средств Node.js.
