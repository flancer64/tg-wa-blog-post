# Testing Contract

Path: `./ctx/docs/code/testing.md`

## Назначение

Документ фиксирует инженерные инварианты тестирования Telegram Translation Publisher. Уровень определяет типы тестов, структуру размещения, правила composition root, DI-модель и допустимые границы побочных действий.

Тесты рассматриваются как равноправная часть кодовой базы.

В проекте поддерживаются два нормативных типа тестирования:

- unit-тестирование;
- dev-тестирование.

Интеграционные и e2e-тесты вне модели dev не входят в контракт.

---

## Статус тестов в проекте

Для всех `.mjs`-модулей в `src/` наличие unit-тестов является нормой по умолчанию.

Отсутствие unit-теста допускается только для:

- production bootstrap (см. `./ctx/docs/code/bootstrap.md`);
- CLI entry-файла.

Dev-тесты:

- не являются обязательными для каждого модуля;
- создаются по необходимости;
- используются для ручной проверки кода, созданного агентом;
- входят в нормативный Testing Contract как дисциплинированный инженерный механизм.

---

## Типы тестирования

### Unit Testing

#### Размещение

Unit-тесты размещаются исключительно в:

```txt
./test/unit/
```

Размещение тестов внутри `src/` не допускается.

##### Зоны тестирования

```txt
test/unit/back/
test/unit/web/
```

В текущем продукте используется backend-зона:

```txt
test/unit/back/
```

##### Зеркальность структуры

Структура каталогов внутри `test/unit/back/` повторяет структуру `src/`.

Пример:

```txt
src/Service/Publisher.mjs
→
test/unit/back/Service/Publisher.test.mjs
```

Зеркальность структуры обязательна.

#### Unit Composition Root

Unit-тесты используют отдельный bootstrap:

```txt
test/unit/unit-bootstrap.mjs
```

Нормативная форма зафиксирована в `./ctx/docs/code/testing/unit-bootstrap.md`.

Unit bootstrap:

- не использует production bootstrap;
- создаёт изолированный DI-контейнер;
- включает `enableTestMode()`;
- не выполняет побочных действий;
- не работает с реальной конфигурацией.

Каждый unit-тест создаёт собственный контейнер.

#### DI-модель unit

В unit-тестах:

- используется `enableTestMode()`;
- production-код не импортируется статически;
- доступ к компонентам осуществляется через `container.get(...)`;
- допускается `container.register` для подмены зависимостей;
- контейнер не передаётся в бизнес-логику.

#### Side effects

Unit-тесты не выполняют реальные побочные действия.

Запрещён прямой доступ к:

- файловой системе;
- `./var/data`;
- Telegram API;
- LLM API;
- сети;
- процессам;
- таймерам.

Все внешние зависимости подменяются.

Каждый unit-тест изолирован и идемпотентен.

---

### Dev Testing

#### Назначение

Dev-тестирование является дисциплинированным инженерным механизмом ручной проверки кода, созданного агентом.

Dev-тест:

- может запускать изолированный фрагмент графа зависимостей;
- может выполнять реальный интеграционный сценарий части системы;
- не является частью продуктового поведения;
- не расширяет CLI-контракт;
- не создаёт альтернативный production-режим;
- может быть удалён без изменения архитектурных инвариантов.

#### Размещение

Dev-тесты размещаются исключительно в:

```txt
./test/dev/
```

Рекомендуемая структура:

```txt
test/
  unit/
  dev/
    dev-bootstrap.mjs
    back/
```

Структура каталогов внутри `test/dev/back/` зеркальна `src/`.

Dev-тесты являются обычными `.test.mjs` файлами и запускаются через `node:test`.

#### Dev Composition Root

Dev-тесты используют отдельный bootstrap:

```txt
test/dev/dev-bootstrap.mjs
```

Dev bootstrap:

- создаёт DI-контейнер;
- включает `enableTestMode()`;
- настраивает namespace root;
- может использовать реальный `ConfigurationLoader`;
- допускает ручную регистрацию или переопределение конфигурации;
- допускает частичную подмену зависимостей через `container.register`.

Dev bootstrap является вспомогательным composition root и не влияет на production bootstrap.

В системе по-прежнему существует ровно один production composition root.

#### DI-модель dev

Dev-тесты:

- используют реальный production-код;
- могут выполнять реальные вызовы LLM API;
- могут выполнять реальные вызовы Telegram API;
- могут выполнять запись в `./var/data`;
- допускают side effects;
- допускают частичную подмену зависимостей.

Dev-тесты не обязаны быть детерминированными или идемпотентными.

#### Конфигурация

Dev-тесты:

- могут читать реальный `.env`;
- могут использовать реальные API-ключи;
- могут переопределять конфигурацию вручную через DI.

Логирование осуществляется стандартным Logger без специального dev-режима.

#### Ограничения

Dev-тесты:

- не изменяют CLI-контракт;
- не изменяют production bootstrap;
- не вводят альтернативных режимов исполнения приложения;
- не становятся частью run-cycle.

Статические импорты project-кода разрешены только внутри `*.test.mjs`.

---

## Инструменты тестирования

Для обоих типов тестов используется нормативный стек:

- `node:test`;
- `node:assert/strict`.

Сторонние тестовые фреймворки не допускаются.

Параллельный запуск тестов допускается при условии, что dev-тесты учитывают возможность side effects.

---

## Итог

Testing-контракт Telegram Translation Publisher фиксирует два нормативных типа тестирования:

- unit — строгая DI-изоляция и запрет побочных действий;
- dev — дисциплинированный инженерный режим интеграционной проверки частей системы.

Production остаётся с единственным composition root. Dev-тестирование расширяет инженерные возможности проверки кода агента, не изменяя архитектурные и продуктовые инварианты системы.
