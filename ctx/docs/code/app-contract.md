# App Contract

Path: `./ctx/docs/code/app-contract.md`

## Назначение

Документ фиксирует инженерный контракт класса `App` в Telegram Translation Publisher. Уровень определяет границы ответственности, форму методов и инварианты поведения без описания прикладных фаз выполнения и без перехода к деталям реализации.

## Роль App

`App` является единственной точкой входа прикладного исполнения в рамках одного CLI-запуска. `App` не содержит прикладной логики репликации и выступает тонким оркестратором, координирующим конфигурацию и запуск прикладного цикла.

Репликационный цикл инкапсулируется отдельным компонентом и вызывается `App` как единая операция.

## Отсутствие CLI-диспетчера

В системе отсутствует CLI-диспетчер и дерево команд. `App` не маршрутизирует выполнение по командам и не поддерживает множественные режимы исполнения. Один запуск соответствует одному прикладному циклу.

## Метод run()

Сигнатура метода:

```js
run({ projectRoot, cliArgs });
```

`run()`:

- принимает `projectRoot`;
- принимает массив аргументов командной строки `cliArgs`;
- самостоятельно обрабатывает исключительные ситуации;
- всегда возвращает числовой `exitCode`;
- не выбрасывает исключения наружу.

Интерпретация `exitCode`:

- `0` — успешная репликация;
- `0` — отсутствие нового сообщения;
- `1` — ошибка выполнения.

## Метод stop()

`App` предоставляет метод `stop()` как часть инженерного контракта жизненного цикла.

В текущей форме системы отсутствуют долгоживущие ресурсы, требующие явного освобождения. Метод `stop()` допускается как noop и не влияет на результат выполнения. Наличие метода закрепляется для симметрии bootstrap-модели и возможного расширения в будущем.

## Границы ответственности

`App`:

- не работает напрямую с `process.env`;
- не вызывает `process.exit`;
- не выполняет прямых HTTP-запросов;
- не записывает файлы напрямую;
- не формирует JSON-структуры агрегата вручную;
- не логирует секреты и токены.

Все внешние взаимодействия осуществляются через внедряемые зависимости (`@teqfw/di`).

## Идемпотентность

Если агрегат с соответствующим `ru_message_id` уже существует, `App` завершает выполнение без побочных действий и возвращает `exitCode = 0`. Факт отсутствия обработки может быть отражён в логах, но не изменяет итоговый код завершения.

## Частичный успех

В случае частичного выполнения репликации:

- агрегат формируется в полном составе;
- поле `status` фиксируется как неуспешное;
- откат опубликованных сообщений не выполняется;
- `run()` возвращает `exitCode = 1`.

## Жёсткая связность каналов

`App` жёстко связан с моделью репликации `ru → en, es`. Добавление новых языков или каналов не входит в текущий контракт и не предполагается данным документом.

## Итог

`App` является оркестратором одного прикладного цикла, управляет конфигурацией и возвратом кода завершения, не содержит прикладной логики и не выполняет прямых инфраструктурных операций. Поведение `App` детерминировано, идемпотентно по отношению к уже обработанным сообщениям и не предполагает множественных режимов исполнения.
