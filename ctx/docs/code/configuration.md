# Configuration Contract

Path: `./ctx/docs/code/configuration.md`

## Назначение

Документ фиксирует поведение конфигурационного слоя Telegram Translation Publisher. Уровень определяет модель загрузки, инициализации и использования конфигурации без повторного описания её структуры.

Конфигурация является startup-данными и не рассматривается как динамическое состояние.

## Общая модель

Конфигурационный слой состоит из трёх компонентов:

- `ConfigurationLoader`;
- `ConfigurationManager`;
- immutable-объекта конфигурации (DTO).

`ConfigurationLoader` отвечает за:

- чтение переменных окружения через `node:process`;
- загрузку `.env` (при наличии);
- формирование полного объекта конфигурации;
- выбрасывание исключения при отсутствии обязательных полей.

`ConfigurationManager` отвечает за:

- однократный вызов `ConfigurationLoader`;
- хранение созданного immutable-объекта конфигурации;
- предоставление метода `get()` для доступа к конфигурации;
- контроль lifecycle (запрет повторной загрузки и запрет доступа до загрузки).

Объект конфигурации является immutable.

## Lifecycle

В рамках одного запуска контейнера:

1. Создаётся singleton `ConfigurationManager`.
2. `App` обязан вызвать `load({ projectRoot })` до запуска прикладной логики.
3. После успешного `load()` конфигурация считается инициализированной.
4. Компоненты получают конфигурацию только через `ConfigurationManager.get()`.

Поведение:

- `get()` до вызова `load()` — исключение.
- Повторный вызов `load()` — запрещён (исключение).
- В рамках одного запуска допускается только один экземпляр конфигурации.

Конфигурация не поддерживает hot-reload.

## Использование в компонентах

Компоненты:

- зависят от `ConfigurationManager$`;
- не зависят напрямую от `ConfigurationLoader`;
- не обращаются к `process.env`;
- не вызывают `load()`;
- не кэшируют конфигурацию в состоянии объекта;
- вызывают `manager.get()` непосредственно в методах при необходимости получить параметры.

Кэширование конфигурации в конструкторе компонента недопустимо.

## Работа с `.env`

Загрузка `.env` выполняется вручную внутри `ConfigurationLoader`.

Bootstrap:

- не передаёт готовую конфигурацию;
- не читает `.env`;
- не работает с `process.env`.

Использование внешних библиотек для загрузки `.env` не предполагается.

## Ошибка конфигурации

Если отсутствует любое обязательное поле:

- `ConfigurationLoader` выбрасывает исключение;
- `ConfigurationManager.load()` пробрасывает исключение;
- агрегат не формируется;
- `App` перехватывает исключение и завершает выполнение с `exitCode = 1`;
- ошибка логируется.

## DI-модель

`ConfigurationLoader` является singleton (`$`).

`ConfigurationManager` является singleton (`$`).

Immutable-объект конфигурации не регистрируется в контейнере напрямую и доступен только через `ConfigurationManager`.

## Доступ к окружению

Только `ConfigurationLoader` имеет право работать с `node:process`.

Остальной код не должен обращаться к `process.env` напрямую.

## Логирование

Конфигурационный слой логирует только ошибки.

Информация о загруженных значениях или ключах не логируется.

## Модель источника данных

Конфигурация жёстко ограничена env-моделью.

Поддержка:

- профилей;
- альтернативных источников конфигурации;
- JSON-файлов;

не предусматривается.

## Итог

Конфигурационный слой Telegram Translation Publisher централизует загрузку параметров из окружения, изолирует прикладной код от `process.env`, использует singleton-менеджер с контролируемым lifecycle и предоставляет immutable-конфигурацию через явный API доступа.
