# Error Handling Contract

Path: `./ctx/docs/code/error-handling.md`

## Назначение

Документ фиксирует кодовые инварианты обработки ошибок: бинарный результат run-cycle, правило формирования агрегата и связь с `exitCode`.

## Бинарная модель результата

Система использует только два результата: `success` и `failure`. Частичный результат относится к `failure`.

## Централизация обработки

Исключения допускаются в нижних слоях и централизованно обрабатываются в `App.run()`. Метод `run()` не выбрасывает исключения наружу и всегда возвращает числовой `exitCode`.

## Правило формирования агрегата

Если ошибка произошла до получения `ru_message_id`, агрегат не формируется. Если `ru_message_id` получен, агрегат формируется после завершения веток en/es даже при `failure`.

## Ошибки публикации и перевода

Ошибка в любой ветке en/es не останавливает вторую ветку, не инициирует rollback публикаций и приводит к `status = failure` и `exitCode = 1`.

## Ошибка атомарной фиксации

Если запись агрегата в storage не удалась, публикации не откатываются и процесс завершается с `exitCode = 1`. Повторный запуск для того же `ru_message_id` может привести к повторной публикации, если агрегат отсутствует.

## Логирование ошибок

Логируются сообщение, stack trace и диагностические данные внешних API без раскрытия секретов.

## Итог

Error-handling Telegram Translation Publisher сохраняет детерминированную бинарную модель исхода run-cycle, централизует преобразование ошибок в `exitCode` и не вводит компенсационных сценариев.
