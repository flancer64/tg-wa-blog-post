# Error Handling Contract

Path: `./ctx/docs/code/error-handling.md`

## Назначение

Документ фиксирует стратегию обработки ошибок в Telegram Translation Publisher на уровне кода. Уровень определяет правила формирования `exitCode`, создания агрегата и поведения системы при сбоях без введения многоуровневой классификации исключений.

## Общая модель

Система использует бинарную модель результата выполнения:

- успех;
- failure.

На уровне кода не вводится специализированная иерархия типов ошибок. Любое исключение рассматривается как failure.

## Ответственность за обработку

Все исключения перехватываются на уровне `App`.

Нижние слои имеют право выбрасывать исключения. Возврат Result-объектов не требуется.

`App.run()`:

- не выбрасывает исключения наружу;
- всегда возвращает числовой `exitCode`.

## Ошибка конфигурации

Если отсутствует обязательная переменная окружения:

- агрегат не формируется;
- выполнение завершается с `exitCode = 1`;
- ошибка логируется.

## Ошибка до получения `ru_message_id`

Если ошибка произошла до получения `ru_message_id` (например, при чтении Telegram):

- агрегат не формируется;
- выполнение завершается с `exitCode = 1`.

Агрегат создаётся только при наличии корректного `ru_message_id`.

## Ошибка во время публикации

Если:

- ru-сообщение получено;
- публикация в одном канале успешна;
- публикация в другом канале или LLM-перевод завершается ошибкой;

то:

- публикации не откатываются;
- агрегат формируется;
- статус агрегата фиксируется как failure;
- `exitCode = 1`.

Публикации выполняются без предварительной полной валидации всех этапов.

## Ошибка записи агрегата

Если публикации выполнены, но запись агрегата в `/var/data` не удалась:

- публикации не откатываются;
- выполнение завершается с `exitCode = 1`.

Повторный запуск может привести к повторной публикации. Это допустимое состояние системы.

## Повторный запуск

Повторная обработка одного `ru_message_id` не выполняется, если агрегат уже существует.

Если предыдущий запуск завершился частичной публикацией без записи агрегата, повторный запуск рассматривается как новая попытка и может привести к повторной публикации. Это допустимо.

## Логирование ошибок

При возникновении исключений:

- логируется сообщение ошибки;
- логируется stack trace;
- логируется тело ответа Telegram и LLM при наличии.

Логирование не должно содержать секретов и токенов.

## Детерминизм

Система не гарантирует, что одному `ru_message_id` соответствует ровно один агрегат.

Ситуация, при которой публикация произошла, но агрегат не записан, является допустимой с точки зрения инвариантов продукта.

## Итог

Error-handling Telegram Translation Publisher строится на простой бинарной модели результата. Исключения допускаются в нижних слоях, централизованно обрабатываются на уровне `App` и приводят к `exitCode = 1`. Система не выполняет rollback, не вводит сложной классификации ошибок и допускает повторную публикацию в случае неудачной записи агрегата.
