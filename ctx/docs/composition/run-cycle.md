# Run Cycle Composition

Path: `./ctx/docs/composition/run-cycle.md`

## Назначение

Документ фиксирует композиционный контракт одного run-cycle Telegram Translation Publisher.

## Последовательность фаз

Один CLI-запуск содержит не более одного run-cycle со следующими фазами:

1. Получение последнего ru-сообщения.
2. При отсутствии сообщения завершение с `exitCode = 0`.
3. Проверка существования агрегата по `ru_message_id`.
4. При наличии агрегата завершение без побочных действий с `exitCode = 0`.
5. Выполнение ветки en: перевод и публикация.
6. Выполнение ветки es: перевод и публикация.
7. Формирование агрегата.
8. Атомарная фиксация агрегата в storage.
9. Возврат итогового `exitCode`.

## Параллельность веток

Ветки en и es независимы и могут выполняться параллельно; порядок их завершения не фиксируется.

## Правило статуса и `exitCode`

`status = success` только при успешном завершении обеих веток публикации, иначе `status = failure`. При `failure` run-cycle завершает CLI-запуск с `exitCode = 1`.

## Идемпотентность

Наличие агрегата для `ru_message_id` блокирует повторный run-cycle и повторную публикацию.

## Итог

Run-cycle является детерминированной фазовой композицией с бинарным статусом агрегата и явными точками раннего завершения.
