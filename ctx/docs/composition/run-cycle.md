# Run Cycle Composition

Path: `./ctx/docs/composition/run-cycle.md`

## Назначение

Документ фиксирует композиционную модель одного прикладного цикла Telegram Translation Publisher. Уровень определяет последовательность фаз выполнения, точки завершения и правила формирования агрегата.

## Точка входа

Run-cycle запускается только после успешной инициализации конфигурации.

Если конфигурация не создана, прикладной цикл не начинается.

## Последовательность фаз

Один запуск CLI соответствует одному run-cycle со следующей последовательностью:

1. Получение последнего сообщения из ru-канала.
2. Если сообщение отсутствует — завершение с `exitCode = 0`.
3. Проверка существования агрегата по `ru_message_id`.
4. Если агрегат существует:
   - логирование на уровне `info`;
   - завершение без побочных действий;
   - `exitCode = 0`.
5. Запуск ветки перевода и публикации для `en`.
6. Запуск ветки перевода и публикации для `es`.
7. Формирование агрегата.
8. Запись агрегата в storage.
9. Возврат `exitCode`.

## Параллельность

Ветки `en` и `es` допускают параллельное выполнение:

- перевод `en` и `es` может выполняться параллельно;
- публикация `en` и `es` может выполняться параллельно;
- ветки не зависят друг от друга.

Порядок публикаций не фиксируется.

## Поведение при ошибках

Если одна из веток (`en` или `es`) завершилась ошибкой:

- вторая ветка всё равно выполняется;
- агрегат формируется;
- `status` агрегата устанавливается в `failure`;
- `exitCode = 1`.

Если обе ветки успешны:

- `status = success`;
- `exitCode = 0`.

## Ошибка записи агрегата

Если запись агрегата не удалась:

- публикации не откатываются;
- `exitCode = 1`.

## Формирование агрегата

Агрегат формируется после завершения обеих веток (`en` и `es`), независимо от их результата.

Агрегат отражает фактическое состояние выполнения веток на момент завершения цикла.

## Идемпотентность

Если агрегат для данного `ru_message_id` уже существует:

- run-cycle немедленно завершается;
- повторные переводы и публикации не выполняются;
- состояние логируется.

## Ограниченность модели

Run-cycle представляет собой фиксированную последовательность фаз.

Добавление новых фаз, побочных эффектов или альтернативных сценариев выполнения не входит в текущий контракт.

## Итог

Run-cycle Telegram Translation Publisher является детерминированной последовательностью операций, выполняемой один раз за запуск. Он поддерживает параллельные ветки перевода и публикации, формирует агрегат по итогам выполнения и завершает процесс с бинарным статусом.
