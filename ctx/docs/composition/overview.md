# Прикладная композиция выполнения

Path: `./ctx/docs/composition/overview.md`

## Назначение уровня

Документ фиксирует прикладную сборку архитектурной формы Telegram Translation Publisher в исполняемый механизм CLI-утилиты. Уровень описывает структуру запуска, конфигурационную модель и организацию хранения без перехода к деталям реализации.

## CLI-команда

Система предоставляет одну CLI-команду, выполняемую в batch-режиме без параметров и без интерактивного взаимодействия. Каждый запуск обрабатывает не более одного сообщения.

Команда всегда получает последнее сообщение из ru-канала и не допускает указания альтернативного `message_id` или режима dry-run.

## Фазовая композиция выполнения

Один запуск CLI состоит из следующих фаз:

1. Получение последнего сообщения из ru-канала.
2. Проверка наличия агрегата с соответствующим `ru_message_id` в файловом хранилище.
3. Если агрегат уже существует — завершение выполнения без побочных действий.
4. Языковое преобразование текста для en.
5. Языковое преобразование текста для es.
6. Публикация сообщения в en-канал.
7. Публикация сообщения в es-канал.
8. Формирование агрегата публикации.
9. Атомарная запись агрегата в файловое хранилище.

Отсутствие нового сообщения не рассматривается как ошибка выполнения.

## Формат агрегата

Агрегат сохраняется в формате JSON с кодировкой UTF-8.  
Временные атрибуты фиксируются в формате ISO 8601.  
Структура документа соответствует доменной модели и содержит полный набор атрибутов независимо от результата репликации.

## Организация хранения

Агрегаты публикаций сохраняются в каталоге:

```txt
/var/data/
```

Каждый агрегат соответствует одному JSON-файлу.  
Имя файла формируется на основе временного маркера фиксации и `ru_message_id`.

Индекс агрегатов не используется.

## Конфигурационная модель

Конфигурация системы определяется через переменные окружения и `.env`-файл.

Обязательные параметры:

- `TELEGRAM_TOKEN`
- `RU_CHAT_ID`
- `EN_CHAT_ID`
- `ES_CHAT_ID`
- `LLM_API_KEY`

Системные промпты для языкового преобразования не задаются через переменные окружения и размещаются в отдельных Markdown-файлах в каталоге:

```txt
/var/prompt/
```

Каждый язык имеет собственный файл промпта.

## Логирование

Логирование осуществляется исключительно в стандартный поток вывода (stdout).  
Файловое логирование не используется.  
Уровни логирования определяются на уровне кода и не фиксируются данным документом.

## Завершение выполнения

Команда возвращает код завершения.  
Успешная обработка нового сообщения и штатная ситуация отсутствия нового сообщения рассматриваются как корректное завершение.  
Ошибки взаимодействия с внешними интерфейсами приводят к завершению с кодом ошибки.

## Итог

Композиционный уровень фиксирует Telegram Translation Publisher как однокомандную batch-утилиту, обрабатывающую последнее сообщение ru-канала, выполняющую независимые языковые преобразования и публикации, формирующую агрегат в формате JSON и фиксирующую результат атомарной записью в файловое хранилище.
