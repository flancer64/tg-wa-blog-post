# Прикладная композиция выполнения

Path: `./ctx/docs/composition/overview.md`

## Назначение уровня

Документ фиксирует прикладную сборку архитектурной формы Telegram Translation Publisher в исполняемый механизм CLI-утилиты. Уровень описывает структуру запуска, конфигурационную модель и организацию хранения без перехода к деталям реализации.

## CLI-команда

Система предоставляет одну CLI-команду, выполняемую в batch-режиме без параметров и без интерактивного взаимодействия. Каждый запуск обрабатывает не более одного сообщения и всегда получает последнее сообщение из ru-канала. Указание альтернативного `message_id` или режимов dry-run не допускается.

## Фазовая композиция выполнения

Один запуск CLI включает получение последнего сообщения из ru-канала, проверку наличия агрегата с соответствующим `ru_message_id` в файловом хранилище, завершение без побочных действий при наличии агрегата, языковое преобразование текста для en и es, публикацию сообщений в соответствующие каналы, формирование агрегата публикации и его атомарную запись в файловое хранилище. Отсутствие нового сообщения не рассматривается как ошибка выполнения.

## Формат агрегата

Агрегат сохраняется в формате JSON с кодировкой UTF-8. Временные атрибуты фиксируются в формате ISO 8601. Структура документа соответствует доменной модели и содержит полный набор атрибутов независимо от результата репликации.

## Организация хранения

Агрегаты публикаций сохраняются в каталоге `/var/data/`. Каждый агрегат соответствует одному JSON-файлу, имя которого формируется на основе временного маркера фиксации и `ru_message_id`. Индекс агрегатов не используется.

## Конфигурационная модель

Конфигурация определяется через переменные окружения и `.env`-файл. Обязательными параметрами являются `TELEGRAM_TOKEN`, `RU_CHAT_ID`, `EN_CHAT_ID`, `ES_CHAT_ID` и `LLM_API_KEY`. Системные промпты языкового преобразования размещаются в отдельных Markdown-файлах в каталоге `/var/prompt/`, при этом каждому языку соответствует отдельный файл.

## Логирование

Логирование осуществляется исключительно в стандартный поток вывода (stdout). Файловое логирование не используется. Уровни логирования определяются на уровне кода.

## Завершение выполнения

Команда возвращает код завершения. Обработка нового сообщения и штатная ситуация отсутствия нового сообщения рассматриваются как корректное завершение. Ошибки взаимодействия с внешними интерфейсами приводят к завершению с кодом ошибки.

## Итог

Композиционный уровень фиксирует систему как однокомандную batch-утилиту, обрабатывающую последнее сообщение ru-канала, выполняющую независимые языковые преобразования и публикации, формирующую агрегат в формате JSON и фиксирующую результат атомарной записью в файловое хранилище.
